<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoyageTracker - Shipment Tracking</title>
    <!-- Google Fonts for elegant typography and Material Icons for iconography -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- NEW: Library for reading Excel (.xlsx) and CSV files -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /*
        ======================================================================
        CSS STYLING SECTION
        ======================================================================
        */

        :root {
            --primary-color: #6a85e6; /* Pastel Blue/Violet */
            --accent-color: #3b50c0;
            --background-start: #f4f7fa;
            --background-end: #e8ecf2;
            --card-background: #ffffff;
            --text-color: #333333;
            --light-text: #6c757d;
            --border-color: #e9ecef;
            --shadow-light: rgba(149, 157, 165, 0.1);
            --shadow-hover: rgba(149, 157, 165, 0.2);
            --warning-yellow: #fff3cd; /* Highlighting */
            --danger-red: #f8d7da; /* Highlighting */
            --danger-color: #dc3545;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Header & Search --- */
        header {
            text-align: center;
            padding: 20px 0 40px;
        }

        h1 {
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 2.5rem;
        }

        .search-container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        #globalSearch {
            width: 100%;
            padding: 12px 20px 12px 50px;
            border: 1px solid var(--border-color);
            border-radius: 30px;
            font-size: 1rem;
            box-shadow: 0 4px 10px var(--shadow-light);
            transition: box-shadow 0.3s, border-color 0.3s;
            outline: none;
        }

        .search-container .material-icons-outlined {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
            font-size: 1.2rem;
        }

        #searchResults {
            position: absolute;
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 8px 16px var(--shadow-hover);
            margin-top: 5px;
            list-style: none;
            padding: 0;
            border: 1px solid var(--border-color);
        }

        #searchResults li {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        #searchResults li:hover {
            background-color: var(--background-start);
        }

        /* --- Vessel Grid --- */
        .vessel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            padding: 30px 0;
            max-width: 1400px;
            margin: 0 auto;
        }

        .vessel-card, .add-vessel-card {
            background: var(--card-background);
            border-radius: 15px;
            box-shadow: 0 4px 12px var(--shadow-light);
            padding: 25px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .vessel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow-hover);
        }

        .vessel-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .vessel-card-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--light-text);
        }
        .vessel-voyage, .vessel-etd {
            margin-bottom: 5px;
        }

        .add-vessel-card {
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 150px;
            border: 2px dashed var(--border-color);
            color: var(--light-text);
        }
        .add-vessel-card-icon {
            font-size: 3rem;
        }
        .add-vessel-card-text {
            font-weight: 600;
            margin-top: 10px;
        }


        /* --- Modal/Form Styling --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        #shipmentForm .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 30px;
            margin-bottom: 20px;
        }
        
        #shipmentForm .submit-btn {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .submit-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex; /* Added for icon support */
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .submit-btn:hover {
            background-color: var(--accent-color);
        }


        /* --- Detail Page Specific Styles --- */
        .detail-page-content {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px var(--shadow-light);
        }

        .vessel-detail-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .vessel-title-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
            margin-bottom: 10px;
        }
        
        .vessel-detail-header h2 {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .action-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, opacity 0.2s;
            background-color: var(--primary-color);
            color: white;
            line-height: 1.2;
        }
        .action-btn:hover {
            opacity: 0.9;
        }
        
        .action-btn.delete-vessel {
            background-color: var(--danger-color);
        }
        .action-btn.summary { background-color: #ffc107; color: var(--text-color);}
        .action-btn.excel { background-color: #28a745; }


        .shipments-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .shipment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 1000px;
        }

        .shipment-table th, .shipment-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .shipment-table th {
            background-color: var(--background-start);
            font-weight: 600;
        }

        /* Highlighting Styles */
        .highlight-yellow {
            background-color: var(--warning-yellow) !important;
        }
        .highlight-red {
            background-color: var(--danger-red) !important;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .action-cell {
            display: flex;
            gap: 5px;
        }
        .edit-btn, .copy-btn, .delete-shipment-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
            padding: 5px;
            line-height: 1;
        }
        .edit-btn { color: var(--primary-color); }
        .delete-shipment-btn { color: var(--danger-color); }
        .edit-btn:hover { color: var(--accent-color); }
        .delete-shipment-btn:hover { opacity: 0.8; }
        
        /* Style for the Copy Button */
        .copy-btn { 
            color: #20c997; /* A vibrant green for duplication */
        }
        .copy-btn:hover { 
            color: #15956f; 
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .vessel-grid { grid-template-columns: 1fr; gap: 20px; }
            .vessel-name { font-size: 1.5rem; }
            .modal-content { margin: 20px; width: auto; max-width: 95%; }

            /* IMPORTANT: Compact Form Stacks on Mobile */
            #shipmentForm .form-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
            .shipment-table-container { overflow-x: auto; }
            .detail-page-content { padding: 15px; }
            .vessel-title-group { flex-direction: column; align-items: flex-start; }
            .vessel-detail-header h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <!--
    ==========================================================================
    MAIN APPLICATION STRUCTURE (Dynamic Content Injection Point)
    ==========================================================================
    -->
    <div id="appContainer">
        <!-- Content injected by JavaScript based on URL (Homepage or Detail Page) -->
    </div>

    <!--
    ==========================================================================
    MODAL (Forms only)
    ==========================================================================
    -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div id="modalContentArea">
                <!-- Form content will be injected here -->
            </div>
        </div>
    </div>

    <!--
    ==========================================================================
    JAVASCRIPT LOGIC SECTION
    ==========================================================================
    -->
    <script>
        // GLOBAL APPLICATION STATE
        let APP_STATE = {
            vessels: [],
            currentVesselId: null,
            // Used temporarily to store parsed data before final confirmation
            bulkImportData: null, 
        };

        const LOCAL_STORAGE_KEY = 'voyageTrackerData';

        /*
        ----------------------------------------------------------------------
        1. DATA MANAGEMENT BLOCK
        ----------------------------------------------------------------------
        */

        function loadData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) {
                try {
                     APP_STATE.vessels = JSON.parse(data);
                } catch(e) {
                    console.error("Error loading or parsing data from local storage:", e);
                    APP_STATE.vessels = [];
                }
            } else {
                APP_STATE.vessels = [];
            }
        }

        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(APP_STATE.vessels));
        }

        function getVesselById(id) {
            return APP_STATE.vessels.find(v => v.id === id);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function addVessel(vesselData) {
            const newVessel = {
                id: generateId(),
                ...vesselData,
                shipments: []
            };
            APP_STATE.vessels.push(newVessel);
            saveData();
            if (!getVesselIdFromUrl()) {
                 renderHomepage();
            }
        }

        function deleteVessel(id) {
            APP_STATE.vessels = APP_STATE.vessels.filter(v => v.id !== id);
            saveData();
        }

        function addShipment(vesselId, shipmentData) {
            const vessel = getVesselById(vesselId);
            if (vessel) {
                const newShipment = {
                    id: generateId(),
                    ...shipmentData,
                    // Ensure dates/link are defaulted to empty string if missing
                    pickupDate: shipmentData.pickupDate || '',
                    forwardingDate: shipmentData.forwardingDate || '',
                    tariffLink: shipmentData.tariffLink || '',
                    numberOfContainers: shipmentData.numberOfContainers || 1,
                    weight: shipmentData.weight || 0,
                };
                vessel.shipments.push(newShipment);
                saveData();
                renderVesselDetail(vesselId);
            }
        }
        
        /**
         * NEW: Helper function to add multiple shipments at once (from excel)
         */
        function addBulkShipments(vesselId, newShipments) {
            const vessel = getVesselById(vesselId);
            if (vessel) {
                // Ensure default values are set for all imported shipments
                const sanitizedShipments = newShipments.map(s => ({
                    ...s,
                    id: generateId(),
                    pickupDate: s.pickupDate || '',
                    forwardingDate: s.forwardingDate || '',
                    tariffLink: s.tariffLink || '',
                    numberOfContainers: parseInt(s.numberOfContainers) || 1,
                    weight: parseFloat(s.weight) || 0,
                }));
                vessel.shipments.push(...sanitizedShipments);
                saveData();
                renderVesselDetail(vesselId);
            }
        }

        /**
         * Creates a duplicate of an existing shipment entry.
         * @param {string} vesselId - The ID of the vessel containing the shipment.
         * @param {string} shipmentId - The ID of the shipment to copy.
         */
        function copyShipment(vesselId, shipmentId) {
            const vessel = getVesselById(vesselId);
            if (vessel) {
                const originalShipment = vessel.shipments.find(s => s.id === shipmentId);
                if (originalShipment) {
                    const newShipment = {
                        ...originalShipment,
                        id: generateId(), // CRUCIAL: Generate a new unique ID
                        bookingNumber: originalShipment.bookingNumber + ' (COPY)' // Mark as a copy
                    };
                    vessel.shipments.push(newShipment);
                    saveData();
                    renderVesselDetail(vesselId);
                }
            }
        }

        function editShipment(vesselId, shipmentId, newShipmentData) {
            const vessel = getVesselById(vesselId);
            if (vessel) {
                const index = vessel.shipments.findIndex(s => s.id === shipmentId);
                if (index !== -1) {
                    vessel.shipments[index] = { ...vessel.shipments[index], ...newShipmentData };
                    saveData();
                    renderVesselDetail(vesselId);
                }
            }
        }
        
        function deleteShipment(vesselId, shipmentId) {
            const vessel = getVesselById(vesselId);
            if (vessel) {
                // Using a custom confirmation message since native confirm() is not allowed.
                if (confirmDeletion("Are you sure you want to delete this shipment record?")) {
                    vessel.shipments = vessel.shipments.filter(s => s.id !== shipmentId);
                    saveData();
                    renderVesselDetail(vesselId);
                }
            }
        }

        // Simple mock for alert/confirm since they are forbidden in the prompt instructions
        function confirmDeletion(message) {
            console.warn("NOTE: A real app would use a custom modal for this confirmation:", message);
            return window.confirm(message); // Using native confirm for function parity in a non-production environment
        }


        /*
        ----------------------------------------------------------------------
        2. UI RENDERING BLOCK
        ----------------------------------------------------------------------
        */

        function renderHomepage() {
            document.getElementById('appContainer').innerHTML = `
                <header>
                    <h1>Shipment Tracking</h1>
                    <div style="text-align: center; margin-bottom: 20px;" class="action-buttons-container">
                        <button class="action-btn" onclick="copyRawData()" style="background-color: #007bff;">
                            <span class="material-icons-outlined">content_copy</span> Copy Raw Backup
                        </button>
                        <button class="action-btn" onclick="restoreRawData()" style="background-color: #ff4785;">
                            <span class="material-icons-outlined">upload</span> Restore Raw Backup
                        </button>
                    </div>

                    <div class="search-container">
                        <span class="material-icons-outlined">search</span>
                        <input type="text" id="globalSearch" placeholder="Search for Vessel, Voyage, or Booking Number...">
                        <ul id="searchResults" style="display: none;"></ul>
                    </div>
                </header>

                <main class="vessel-grid" id="vesselGrid">
                    <!-- Vessel Cards will be injected here -->
                    <div class="add-vessel-card" id="addVesselCard">
                        <span class="add-vessel-card-icon material-icons-outlined">add_circle_outline</span>
                        <span class="add-vessel-card-text">+ Add New Vessel</span>
                    </div>
                </main>
            `;

            document.getElementById('addVesselCard').addEventListener('click', () => showAddVesselForm());
            document.getElementById('globalSearch').addEventListener('input', handleGlobalSearch);
            document.addEventListener('click', (e) => {
                const resultsList = document.getElementById('searchResults');
                if (resultsList && !e.target.closest('.search-container') && !e.target.closest('li')) {
                    resultsList.style.display = 'none';
                }
            });

            renderVesselCards();
        }

        function renderVesselCards() {
            const grid = document.getElementById('vesselGrid');
            if (!grid) return;

            const addCard = document.getElementById('addVesselCard');
            // Remove existing dynamically added cards before re-rendering
            grid.querySelectorAll('.vessel-card').forEach(card => card.remove());

            APP_STATE.vessels.forEach(vessel => {
                const card = document.createElement('div');
                card.className = 'vessel-card';
                card.setAttribute('data-id', vessel.id);
                card.innerHTML = `
                    <div class="vessel-card-content">
                        <div class="vessel-name">${vessel.vesselName}</div>
                    </div>
                    <div class="vessel-card-footer">
                        <div class="vessel-voyage">Voyage: <strong>${vessel.voyage}</strong></div>
                        <div class="vessel-etd">ETD: <strong>${vessel.etd}</strong></div>
                    </div>
                `;
                grid.insertBefore(card, addCard);
                card.addEventListener('click', () => {
                    // Navigate to the detail page in a new window/tab
                    window.open(`${window.location.pathname}?vesselId=${vessel.id}`, '_blank');
                });
            });
        }

        function renderVesselDetail(vesselId) {
            const vessel = getVesselById(vesselId);
            if (!vessel) {
                document.getElementById('appContainer').innerHTML = `<div class="detail-page-content" style="text-align:center;"><h2>Vessel Not Found</h2><p>The vessel ID is invalid.</p><p><a href="${window.location.pathname}">Go back to Homepage</a></p></div>`;
                return;
            }

            APP_STATE.currentVesselId = vesselId;

            document.getElementById('appContainer').innerHTML = `
                <div class="detail-page-content">
                    <a href="${window.location.pathname}" style="display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; text-decoration: none; color: var(--text-color);">
                        <span class="material-icons-outlined" style="vertical-align: middle;">arrow_back</span> Back to Homepage
                    </a>
                    
                    <div class="vessel-detail-header">
                        <div class="vessel-title-group">
                            <button class="action-btn delete-vessel" onclick="confirmDeleteVessel('${vessel.id}', '${vessel.vesselName}')">
                                <span class="material-icons-outlined">delete</span>Delete Vessel
                            </button>
                            <h2>${vessel.vesselName} (${vessel.voyage})</h2>
                        </div>
                    </div>
                    <div style="font-size: 1.1rem; margin-bottom: 20px;">ETD: <strong>${vessel.etd}</strong></div>

                    <div class="action-buttons">
                        <button class="action-btn" onclick="showAddShipmentForm('${vessel.id}')">
                            <span class="material-icons-outlined">add</span>Add Shipment
                        </button>
                        <!-- NEW BUTTON FOR BULK UPLOAD -->
                        <button class="action-btn" onclick="showUploadForm('${vessel.id}')" style="background-color: #007bff;">
                            <span class="material-icons-outlined">upload_file</span>Upload Shipments
                        </button>
                        <button class="action-btn summary" onclick="openVesselSummary('${vessel.id}')">
                            <span class="material-icons-outlined">summarize</span>Vessel Summary
                        </button>
                        <button class="action-btn excel" onclick="exportShipmentsToExcel('${vessel.id}')">
                            <span class="material-icons-outlined">download</span>Export to CSV
                        </button>
                    </div>

                    <h3>Shipments Management</h3>
                    <div class="shipments-table-container">
                        ${createShipmentsTable(vessel.shipments, vessel.id)}
                    </div>
                </div>
            `;
            attachTableEditListeners(vessel.id);
        }

        function createShipmentsTable(shipments, vesselId) {
            if (shipments.length === 0) {
                return '<p style="margin-top: 15px;">No shipments added yet.</p>';
            }

            const headers = [
                'Booking Number', 'Customer Name', 'Container Type', 'Weight', 'Cont. Count',
                'T/S Port', 'POD', 'Allotment Date', 'Pickup Date', 'Forwarding Date', 'Tariff Date', 'Actions'
            ];

            let tableHtml = `<table class="shipment-table"><thead><tr>`;
            headers.forEach(h => { tableHtml += `<th>${h}</th>`; });
            tableHtml += `</tr></thead><tbody>`;

            shipments.forEach(s => {
                // Apply highlighting based on date checks
                const pickupClass = getPickupHighlightClass(s.allotmentDate, s.pickupDate);
                const forwardingClass = getForwardingHighlightClass(s.pickupDate, s.forwardingDate);
                const pendingText = '<span style="color: grey;">(Pending)</span>';

                tableHtml += `<tr>
                    <td>${s.bookingNumber}</td>
                    <td>${s.customerName}</td>
                    <td>${s.containerType}</td>
                    <td>${s.weight}</td>
                    <td>${s.numberOfContainers}</td>
                    <td>${s.tsPort}</td>
                    <td>${s.pod}</td>
                    <td>${s.allotmentDate}</td>
                    <td class="${pickupClass}">
                        ${s.pickupDate || pendingText}
                    </td>
                    <td class="${forwardingClass}">
                        ${s.forwardingDate || pendingText}
                    </td>
                    <td>${s.tariffLink || 'N/A'}</td>
                    <td class="action-cell">
                        <button class="edit-btn" data-shipment-id="${s.id}" title="Edit Shipment">
                            <span class="material-icons-outlined">edit</span>
                        </button>
                        <button class="copy-btn" onclick="copyShipment('${vesselId}', '${s.id}')" title="Duplicate Shipment">
                            <span class="material-icons-outlined">content_copy</span>
                        </button>
                        <button class="delete-shipment-btn" onclick="deleteShipment('${vesselId}', '${s.id}')" title="Delete Shipment">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    </td>
                </tr>`;
            });

            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        function showAddVesselForm() {
            document.getElementById('modalContentArea').innerHTML = `
                <div class="modal-header">
                    <h2>➕ Add New Vessel</h2>
                    <button class="close-btn" onclick="hideModal()">✖</button>
                </div>
                <form id="addVesselForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="vesselName">Vessel Name</label>
                            <input type="text" id="vesselName" name="vesselName" required>
                        </div>
                        <div class="form-group">
                            <label for="voyage">Voyage</label>
                            <input type="text" id="voyage" name="voyage" required>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="etd">Estimated Time of Departure (ETD)</label>
                            <input type="date" id="etd" name="etd" required>
                        </div>
                        <button type="submit" class="submit-btn">Save Vessel</button>
                    </div>
                </form>
            `;
            document.getElementById('formModal').style.display = 'flex';
            document.getElementById('addVesselForm').addEventListener('submit', handleAddVesselSubmit);
        }

        function showAddShipmentForm(vesselId, shipment = null) {
            APP_STATE.currentVesselId = vesselId;
            const isEdit = !!shipment;
            const title = isEdit ? '✏️ Edit Shipment' : '➕ Add New Shipment';

            document.getElementById('modalContentArea').innerHTML = `
                <div class="modal-header">
                    <h2>${title}</h2>
                    <button class="close-btn" onclick="hideModal()">✖</button>
                </div>
                <form id="shipmentForm" data-vessel-id="${vesselId}" data-shipment-id="${shipment ? shipment.id : ''}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="bookingNumber">Booking Number</label>
                            <input type="text" id="bookingNumber" name="bookingNumber" value="${shipment ? shipment.bookingNumber : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" name="customerName" value="${shipment ? shipment.customerName : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="containerType">Container Type</label>
                            <select id="containerType" name="containerType" required>
                                <option value="">Select Type</option>
                                <option value="20ft" ${shipment && shipment.containerType === '20ft' ? 'selected' : ''}>20ft</option>
                                <option value="40ft" ${shipment && shipment.containerType === '40ft' ? 'selected' : ''}>40ft</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="weight">Weight (Tons)</label>
                            <input type="number" step="0.01" id="weight" name="weight" value="${shipment ? shipment.weight : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="numberOfContainers">Number of Containers</label>
                            <input type="number" id="numberOfContainers" name="numberOfContainers" value="${shipment ? shipment.numberOfContainers : '1'}" required>
                        </div>
                        <div class="form-group">
                            <label for="tsPort">T/S Port</label>
                            <input type="text" id="tsPort" name="tsPort" value="${shipment ? shipment.tsPort : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="pod">POD</label>
                            <input type="text" id="pod" name="pod" value="${shipment ? shipment.pod : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="allotmentDate">Allotment Date</label>
                            <input type="date" id="allotmentDate" name="allotmentDate" value="${shipment ? shipment.allotmentDate : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="pickupDate">Pickup Date (Optional)</label>
                            <input type="date" id="pickupDate" name="pickupDate" value="${shipment ? shipment.pickupDate : ''}">
                        </div>
                        <div class="form-group">
                            <label for="forwardingDate">Forwarding Date (Optional)</label>
                            <input type="date" id="forwardingDate" name="forwardingDate" value="${shipment ? shipment.forwardingDate : ''}">
                        </div>
                        <div class="form-group">
                            <label for="tariffLink">Tariff Date (Optional)</label>
                            <input type="date" id="tariffLink" name="tariffLink" value="${shipment ? shipment.tariffLink : ''}">
                        </div>
                        <button type="submit" class="submit-btn">${isEdit ? 'Update Shipment' : 'Create Shipment'}</button>
                    </div>
                </form>
            `;
            document.getElementById('formModal').style.display = 'flex';
            document.getElementById('shipmentForm').addEventListener('submit', isEdit ? handleEditShipmentSubmit : handleAddShipmentSubmit);
        }

        /**
         * NEW: Displays the modal for file upload.
         */
        function showUploadForm(vesselId) {
            APP_STATE.currentVesselId = vesselId;

            document.getElementById('modalContentArea').innerHTML = `
                <div class="modal-header">
                    <h2>⬆️ Bulk Shipment Upload</h2>
                    <button class="close-btn" onclick="hideModal()">✖</button>
                </div>
                <div id="uploadFormContent" data-vessel-id="${vesselId}">
                    <div class="form-group">
                        <label for="fileInput">Select Excel (.xlsx) or CSV file</label>
                        <input type="file" id="fileInput" accept=".xlsx,.csv" required style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <p id="uploadStatus" style="margin-top: 15px; font-weight: 600;"></p>
                    <div id="dataPreview" class="shipments-table-container" style="max-height: 300px; overflow-y: auto; margin-top: 20px; display: none;"></div>
                    <button id="confirmUploadBtn" class="submit-btn" style="margin-top: 20px; display: none;">
                        <span class="material-icons-outlined">save</span> Confirm and Add Shipments
                    </button>
                    <p style="margin-top: 20px; font-size: 0.85rem; color: var(--light-text);">
                        Ensure your file contains these columns: <strong>Bkg.RefNo, Booked by, Cntr Type, Gr.Wt(Tons), TS Ports, FPD, Date(DD/MM/YYY)</strong>.
                    </p>
                </div>
            `;
            document.getElementById('formModal').style.display = 'flex';
            document.getElementById('fileInput').addEventListener('change', (e) => handleFileUpload(e, vesselId));
        }

        function hideModal() {
            document.getElementById('formModal').style.display = 'none';
        }


        /*
        ----------------------------------------------------------------------
        3. EVENT HANDLERS BLOCK
        ----------------------------------------------------------------------
        */
        
        // --- Column Mapping for Excel Import ---
        const EXCEL_COLUMN_MAPPINGS = {
            'Bkg.RefNo': 'bookingNumber',
            'Booked by': 'customerName',
            'Cntr Type': 'containerType',
            'Gr.Wt(Tons)': 'weight',
            'TS Ports': 'tsPort',
            'FPD': 'pod',
            'Date(DD/MM/YYY)': 'allotmentDate',
        };

        function normalizeHeader(header) {
            if (typeof header !== 'string') return '';
            // Standardizes header by removing spaces, dots, and converting to lowercase
            return header.replace(/[\s\.]/g, '').toLowerCase();
        }

        /**
         * NEW: Handles file change, parses data, and shows preview.
         */
        function handleFileUpload(e, vesselId) {
            const file = e.target.files[0];
            const statusEl = document.getElementById('uploadStatus');
            const previewEl = document.getElementById('dataPreview');
            const confirmBtn = document.getElementById('confirmUploadBtn');

            statusEl.innerHTML = '';
            previewEl.style.display = 'none';
            confirmBtn.style.display = 'none';
            
            if (!file) return;

            // Check if XLSX library is available
            if (typeof XLSX === 'undefined') {
                statusEl.style.color = 'red';
                statusEl.textContent = 'ERROR: XLSX library is not loaded. Cannot process file.';
                return;
            }

            statusEl.textContent = 'Reading file... (This may take a moment for large files)';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert sheet to array of arrays (raw data)
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (sheetData.length <= 1) { 
                        statusEl.style.color = 'red';
                        statusEl.textContent = 'Error: File is empty or only contains headers.';
                        return;
                    }
                    
                    const [parsedShipments, errorMsg, previewHtml] = processExcelData(sheetData);

                    if (errorMsg) {
                        statusEl.style.color = 'red';
                        statusEl.textContent = 'Error: ' + errorMsg;
                        return;
                    }

                    APP_STATE.bulkImportData = parsedShipments; // Temporarily store parsed data
                    statusEl.style.color = 'green';
                    statusEl.textContent = `Success! ${parsedShipments.length} records parsed and ready for review.`;
                    
                    previewEl.innerHTML = previewHtml;
                    previewEl.style.display = 'block';

                    confirmBtn.style.display = 'block';
                    confirmBtn.onclick = () => {
                        addBulkShipments(vesselId, APP_STATE.bulkImportData);
                        hideModal();
                        // Clean up temporary data after saving
                        delete APP_STATE.bulkImportData;
                    };

                } catch (error) {
                    statusEl.style.color = 'red';
                    statusEl.textContent = 'Error processing file: ' + error.message;
                    console.error("Excel Processing Error:", error);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        /**
         * NEW: Core logic to map excel column data to shipment structure.
         */
        function processExcelData(sheetData) {
            const rawHeaders = sheetData[0];
            const dataRows = sheetData.slice(1);
            const shipments = [];
            
            const headerIndexMap = {}; 
            const missingHeaders = [];

            // 1. Identify column indices based on normalized headers
            Object.entries(EXCEL_COLUMN_MAPPINGS).forEach(([excelKey, dbKey]) => {
                const normalizedKey = normalizeHeader(excelKey);
                const index = rawHeaders.findIndex(h => normalizeHeader(h) === normalizedKey);
                
                if (index !== -1) {
                    headerIndexMap[index] = dbKey;
                } else {
                    missingHeaders.push(excelKey);
                }
            });

            if (!headerIndexMap[rawHeaders.findIndex(h => normalizeHeader(h) === normalizeHeader('Bkg.RefNo'))]) {
                return [null, 'Could not find the mandatory Bkg.RefNo column in the file headers.', null];
            }
            
            // 2. Process each data row
            const previewData = [];

            dataRows.forEach((row, index) => {
                const shipment = {
                    id: generateId(),
                    pickupDate: '',
                    forwardingDate: '',
                    tariffLink: '',
                    numberOfContainers: 1, 
                    weight: 0, 
                };
                let isValid = false; // Must have a booking number

                Object.entries(headerIndexMap).forEach(([colIndex, fieldName]) => {
                    let value = row[parseInt(colIndex, 10)];
                    
                    if (value !== undefined && value !== null) {
                        value = String(value).trim();
                        
                        // Type casting and normalization
                        if (fieldName === 'weight' && value) {
                            // Ensure weight is a number, default to 0 if parsing fails
                            value = parseFloat(value) || 0; 
                        } else if (fieldName === 'allotmentDate' && value) {
                            // Convert date from Excel serial or DD/MM/YYYY string to YYYY-MM-DD
                            if (!isNaN(value) && !isNaN(parseFloat(value))) {
                                // Assume Excel serial date
                                const date = new Date(Date.UTC(0, 0, value - 1));
                                value = date.toISOString().slice(0, 10);
                            } else if (value.match(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/)) {
                                // DD/MM/YYYY format
                                const parts = value.split('/');
                                // Reorder to YYYY-MM-DD
                                value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                // Treat as a literal string if format unknown/invalid
                                value = value; 
                            }
                        } else if (fieldName === 'containerType' && value) {
                            // Simple normalization for container type
                            value = value.toLowerCase().includes('40') ? '40ft' : '20ft';
                        } else if (fieldName === 'bookingNumber' && value) {
                            isValid = true;
                        }

                        shipment[fieldName] = value;
                    }
                });

                if (isValid) {
                    shipments.push(shipment);
                    
                    // Prepare preview data
                    previewData.push({
                        bookingNumber: shipment.bookingNumber,
                        customerName: shipment.customerName,
                        containerType: shipment.containerType,
                        weight: shipment.weight,
                        tsPort: shipment.tsPort,
                        pod: shipment.pod,
                        allotmentDate: shipment.allotmentDate,
                        sourceRow: index + 2 // Row in Excel (1 for header + index + 1)
                    });
                }
            });

            if (shipments.length === 0) {
                return [null, 'No valid shipment data found after parsing. Please check if Bkg.RefNo is present.', null];
            }

            // Generate HTML preview table
            let previewHtml = `<table class="shipment-table" style="min-width: 800px;"><thead><tr>
                <th>Booking Number</th><th>Customer Name</th><th>Cont. Type</th><th>Weight (T)</th><th>T/S Port</th><th>POD</th><th>Allotment Date</th><th>Source Row</th>
            </tr></thead><tbody>`;

            previewData.forEach(s => {
                previewHtml += `<tr>
                    <td>${s.bookingNumber || 'N/A'}</td>
                    <td>${s.customerName || 'N/A'}</td>
                    <td>${s.containerType || 'N/A'}</td>
                    <td>${s.weight || 0}</td>
                    <td>${s.tsPort || 'N/A'}</td>
                    <td>${s.pod || 'N/A'}</td>
                    <td>${s.allotmentDate || 'N/A'}</td>
                    <td>${s.sourceRow}</td>
                </tr>`;
            });

            previewHtml += `</tbody></table>`;

            return [shipments, null, previewHtml];
        }

        function attachTableEditListeners(vesselId) {
            const vessel = getVesselById(vesselId);
            if (!vessel) return;

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const shipmentId = e.currentTarget.getAttribute('data-shipment-id');
                    const shipment = vessel.shipments.find(s => s.id === shipmentId);
                    if (shipment) {
                        showAddShipmentForm(vesselId, shipment);
                    }
                });
            });
            // No need to attach listener for copyShipment or deleteShipment as they use inline onclick
        }

        function handleAddVesselSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const vesselData = {
                vesselName: form.vesselName.value,
                voyage: form.voyage.value,
                etd: form.etd.value,
            };
            addVessel(vesselData);
            hideModal();
        }

        function handleAddShipmentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const vesselId = form.getAttribute('data-vessel-id');

            const shipmentData = {
                bookingNumber: form.bookingNumber.value,
                customerName: form.customerName.value,
                containerType: form.containerType.value,
                weight: parseFloat(form.weight.value),
                numberOfContainers: parseInt(form.numberOfContainers.value, 10),
                tsPort: form.tsPort.value,
                pod: form.pod.value,
                allotmentDate: form.allotmentDate.value,
                pickupDate: form.pickupDate.value,
                forwardingDate: form.forwardingDate.value,
                tariffLink: form.tariffLink.value,
            };
            addShipment(vesselId, shipmentData);
            hideModal();
        }

        function handleEditShipmentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const vesselId = form.getAttribute('data-vessel-id');
            const shipmentId = form.getAttribute('data-shipment-id');

            const newShipmentData = {
                bookingNumber: form.bookingNumber.value,
                customerName: form.customerName.value,
                containerType: form.containerType.value,
                weight: parseFloat(form.weight.value),
                numberOfContainers: parseInt(form.numberOfContainers.value, 10),
                tsPort: form.tsPort.value,
                pod: form.pod.value,
                allotmentDate: form.allotmentDate.value,
                pickupDate: form.pickupDate.value,
                forwardingDate: form.forwardingDate.value,
                tariffLink: form.tariffLink.value,
            };
            editShipment(vesselId, shipmentId, newShipmentData);
            hideModal();
        }

        function confirmDeleteVessel(vesselId, vesselName) {
            if (confirmDeletion(`Are you sure you want to delete the vessel '${vesselName}' and all its shipments? This cannot be undone.`)) {
                deleteVessel(vesselId);
                window.location.href = window.location.pathname; // Redirect to homepage
            }
        }

        function handleGlobalSearch(e) {
            const query = e.target.value.toLowerCase().trim();
            const resultsList = document.getElementById('searchResults');

            if (query.length < 2) {
                resultsList.style.display = 'none';
                return;
            }

            const results = [];
            APP_STATE.vessels.forEach(vessel => {
                // Search in Vessel name and Voyage
                if (vessel.vesselName.toLowerCase().includes(query) || vessel.voyage.toLowerCase().includes(query)) {
                    results.push({ type: 'Vessel', name: `${vessel.vesselName} (${vessel.voyage})`, id: vessel.id });
                }
                // Search in Shipments (Booking Number)
                vessel.shipments.forEach(shipment => {
                    if (shipment.bookingNumber.toLowerCase().includes(query)) {
                        // Prevent duplicate vessel entries if searching for booking number
                        if (!results.some(r => r.id === vessel.id && r.type === 'Shipment')) {
                            results.push({ type: 'Shipment', name: `Booking: ${shipment.bookingNumber} - ${vessel.vesselName}`, id: vessel.id });
                        }
                    }
                });
            });

            const topResults = results.slice(0, 10);

            resultsList.innerHTML = topResults.map(r =>
                `<li data-id="${r.id}" data-type="${r.type}">${r.type}: <strong>${r.name}</strong></li>`
            ).join('');

            resultsList.style.display = topResults.length > 0 ? 'block' : 'none';

            resultsList.querySelectorAll('li').forEach(item => {
                item.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-id');
                    window.open(`${window.location.pathname}?vesselId=${targetId}`, '_blank');
                    resultsList.style.display = 'none';
                    document.getElementById('globalSearch').value = '';
                });
            });
        }


        /*
        ----------------------------------------------------------------------
        4. UTILITY FUNCTIONS BLOCK (Date Logic, Summary, Export)
        ----------------------------------------------------------------------
        */

        function getVesselIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('vesselId');
        }

        /**
         * Calculates the difference in full days between date2 and date1 (date2 - date1).
         * @param {string} date1 - The base date string (YYYY-MM-DD).
         * @param {string} [date2] - The comparison date string (defaults to today, YYYY-MM-DD).
         * @returns {number} The number of days date2 is after date1.
         */
        function dateDiffInDays(date1, date2 = new Date().toISOString().slice(0, 10)) {
            if (!date1 || !date2) return -999; 

            // Use 'T00:00:00Z' to force UTC midnight for consistent, day-based calculation
            const _MS_PER_DAY = 1000 * 60 * 60 * 24;
            const dateObj1 = new Date(date1 + 'T00:00:00Z');
            const dateObj2 = new Date(date2 + 'T00:00:00Z');

            const diffTime = dateObj2.getTime() - dateObj1.getTime();
            return Math.round(diffTime / _MS_PER_DAY);
        }

        /**
         * Applies highlighting rules for Pickup Date based on Allotment Date.
         * Highlight if pickup is pending and allotment date is 2 or more days ago.
         */
        function getPickupHighlightClass(allotmentDate, pickupDate) {
            if (pickupDate) return ''; 

            const today = new Date().toISOString().slice(0, 10);
            const daysPassed = dateDiffInDays(allotmentDate, today);
            
            if (daysPassed >= 3) return 'highlight-red';
            if (daysPassed >= 2) return 'highlight-yellow';

            return '';
        }

        /**
         * Applies highlighting rules for Forwarding Date based on Pickup Date.
         * Highlight if forwarding is pending and pickup date is 2 or more days ago.
         */
        function getForwardingHighlightClass(pickupDate, forwardingDate) {
            if (!pickupDate || forwardingDate) return '';

            const today = new Date().toISOString().slice(0, 10);
            const daysPassed = dateDiffInDays(pickupDate, today);

            if (daysPassed >= 7) return 'highlight-red';
            if (daysPassed >= 2) return 'highlight-yellow';

            return '';
        }

        function calculateSummary(shipments) {
            const summary = { byTsPort: {}, byPod: {}, totalTeus: 0, totalTonnage: 0 };
            shipments.forEach(s => {
                const count = s.numberOfContainers || 0;
                const weight = parseFloat(s.weight) || 0;
                const teusUnit = s.containerType === '20ft' ? 1 : 2;
                const teus = count * teusUnit;

                // T/S Port Summary
                if (!summary.byTsPort[s.tsPort]) { summary.byTsPort[s.tsPort] = { '20ft': 0, '40ft': 0, tonnage: 0, teus: 0 }; }
                summary.byTsPort[s.tsPort][s.containerType] += count;
                summary.byTsPort[s.tsPort].tonnage += weight;
                summary.byTsPort[s.tsPort].teus += teus;

                // POD Summary (Container Count ONLY)
                if (!summary.byPod[s.pod]) { summary.byPod[s.pod] = { '20ft': 0, '40ft': 0 }; }
                summary.byPod[s.pod][s.containerType] += count;

                summary.totalTeus += teus;
                summary.totalTonnage += weight;
            });

            // Calculate totals
            const totalTs20 = Object.values(summary.byTsPort).reduce((acc, curr) => acc + (curr['20ft'] || 0), 0);
            const totalTs40 = Object.values(summary.byTsPort).reduce((acc, curr) => acc + (curr['40ft'] || 0), 0);
            const totalPod20 = Object.values(summary.byPod).reduce((acc, curr) => acc + (curr['20ft'] || 0), 0);
            const totalPod40 = Object.values(summary.byPod).reduce((acc, curr) => acc + (curr['40ft'] || 0), 0);


            summary.byTsPort.TOTALS = { '20ft': totalTs20, '40ft': totalTs40, tonnage: summary.totalTonnage, teus: summary.totalTeus };
            summary.byPod.TOTALS = { '20ft': totalPod20, '40ft': totalPod40 };

            return summary;
        }

        function openVesselSummary(vesselId) {
            const vessel = getVesselById(vesselId);
            if (!vessel) return;

            const summaryData = calculateSummary(vessel.shipments);
            const summaryWindow = window.open('', '_blank');

            summaryWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Vessel Summary - ${vessel.vesselName}</title>
                    <style>
                        ${document.querySelector('style').textContent}
                        body { padding: 40px; background: white; }
                        h1 { font-size: 2rem; color: var(--accent-color); }
                        h2 { margin-top: 30px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }
                        .summary-table { margin-top: 15px; width: 100%; border-collapse: collapse; }
                        .summary-table th, .summary-table td { border: 1px solid var(--border-color); padding: 10px; text-align: left; }
                        .summary-table th { background-color: var(--background-start); color: var(--text-color); }
                        .summary-table tr:last-child { font-weight: 700; background-color: #f0f4ff; }
                    </style>
                </head>
                <body>
                    <h1>Vessel Summary: ${vessel.vesselName} (${vessel.voyage})</h1>
                    <p style="font-size: 1.1rem; margin-bottom: 30px;">ETD: ${vessel.etd}</p>

                    <h2>Summary By T/S Port (Counts, Tonnage, TEUs)</h2>
                    ${generateSummaryTableHtml(summaryData.byTsPort, ['T/S Port', '20ft Count', '40ft Count', 'Tonnage (Tons)', 'TEUs'], 'TsPort')}

                    <h2>Summary By POD (Container Count)</h2>
                    ${generateSummaryTableHtml(summaryData.byPod, ['POD', '20ft Count', '40ft Count', 'Total Containers'], 'Pod')}

                    <p style="margin-top: 40px; color: var(--light-text);">Report generated on: ${new Date().toLocaleDateString()}</p>
                </body>
                </html>
            `);
            summaryWindow.document.close();
        }

        function generateSummaryTableHtml(data, headers, type) {
            let tableHtml = `<table class="summary-table"><thead><tr>`;
            headers.forEach(h => tableHtml += `<th>${h}</th>`);
            tableHtml += `</tr></thead><tbody>`;

            const rows = Object.entries(data).filter(([key]) => key !== 'TOTALS');
            const totals = data.TOTALS || {};

            rows.forEach(([key, values]) => {
                tableHtml += `<tr><td>${key}</td>`;
                if (type === 'TsPort') {
                    tableHtml += `<td>${values['20ft'] || 0}</td>`;
                    tableHtml += `<td>${values['40ft'] || 0}</td>`;
                    tableHtml += `<td>${values.tonnage ? values.tonnage.toFixed(2) : 0}</td>`;
                    tableHtml += `<td>${values.teus || 0}</td>`;
                } else if (type === 'Pod') {
                    const count20 = values['20ft'] || 0;
                    const count40 = values['40ft'] || 0;
                    tableHtml += `<td>${count20}</td>`;
                    tableHtml += `<td>${count40}</td>`;
                    tableHtml += `<td>${count20 + count40}</td>`;
                }
                tableHtml += `</tr>`;
            });

            if (totals && Object.keys(totals).length > 0) {
                tableHtml += `<tr style="font-weight: 700;"><td>TOTALS</td>`;
                if (type === 'TsPort') {
                    tableHtml += `<td>${totals['20ft'] || 0}</td>`;
                    tableHtml += `<td>${totals['40ft'] || 0}</td>`;
                    tableHtml += `<td>${totals.tonnage ? totals.tonnage.toFixed(2) : 0}</td>`;
                    tableHtml += `<td>${totals.teus || 0}</td>`;
                } else if (type === 'Pod') {
                    const count20 = totals['20ft'] || 0;
                    const count40 = totals['40ft'] || 0;
                    tableHtml += `<td>${count20}</td>`;
                    tableHtml += `<td>${count40}</td>`;
                    tableHtml += `<td>${count20 + count40}</td>`;
                }
                tableHtml += `</tr>`;
            }

            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        function exportShipmentsToExcel(vesselId) {
            const vessel = getVesselById(vesselId);
            if (!vessel || vessel.shipments.length === 0) {
                console.log("No shipments to export.");
                return;
            }

            const headers = [
                'VesselName', 'Voyage', 'ETD', 'BookingNumber', 'CustomerName', 'ContainerType',
                'Weight(Tons)', 'NumberContainers', 'TSPort', 'POD', 'AllotmentDate',
                'PickupDate', 'ForwardingDate', 'TariffDate'
            ];

            let csv = headers.join(',') + '\n';

            vessel.shipments.forEach(s => {
                const row = [
                    vessel.vesselName, vessel.voyage, vessel.etd,
                    s.bookingNumber, s.customerName, s.containerType,
                    s.weight, s.numberOfContainers, s.tsPort, s.pod, s.allotmentDate,
                    s.pickupDate, s.forwardingDate, s.tariffLink
                ].map(item => {
                    // Simple CSV escaping: replace quotes with double quotes and wrap in quotes
                    let str = String(item || '').replace(/"/g, '""');
                    return `"${str}"`;
                }).join(',');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Shipments_${vessel.vesselName.replace(/\s/g, '_')}_${vessel.voyage}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /*
        ----------------------------------------------------------------------
        5. MANUAL DATA BACKUP/RESTORE UTILITY (For cache clearing safety)
        ----------------------------------------------------------------------
        */

        // Function to copy the raw data to clipboard
        function copyRawData() {
            const rawData = JSON.stringify(APP_STATE.vessels);
            
            // Use document.execCommand('copy') as navigator.clipboard.writeText() often fails in iframes
            const tempInput = document.createElement('textarea');
            tempInput.value = rawData;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                alert("Raw data copied to clipboard! Paste this into a separate text file for safekeeping.");
            } catch (err) {
                console.error('Could not copy text: ', err);
                alert("Failed to copy data. Please manually copy the raw JSON data from the browser console (APP_STATE.vessels).");
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        // Function to restore the raw data from user input
        function restoreRawData() {
            // Using a simple prompt for now, a real app would use a secure modal input
            const rawData = prompt("PASTE YOUR SAVED RAW DATA STRING BELOW (JSON format):");
            if (rawData) {
                try {
                    const parsedData = JSON.parse(rawData);
                    // Basic validation to ensure it looks like our data structure
                    if (Array.isArray(parsedData) && parsedData.every(v => v.id && v.vesselName && Array.isArray(v.shipments))) {
                        APP_STATE.vessels = parsedData;
                        saveData(); // Save the new data set to Local Storage
                        alert("Data successfully restored! The page will now reload.");
                        window.location.reload();
                    } else {
                        throw new Error("Data structure invalid. Restore aborted.");
                    }
                } catch (e) {
                    alert("ERROR: The pasted data is corrupted or invalid. Restore aborted. Details: " + e.message);
                    console.error("Restore failed:", e);
                }
            } else {
                alert("Restore cancelled.");
            }
        }

        /*
        ----------------------------------------------------------------------
        6. INITIALIZATION BLOCK (The Router)
        ----------------------------------------------------------------------
        */

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            const vesselId = getVesselIdFromUrl();

            if (vesselId) {
                renderVesselDetail(vesselId);
            } else {
                renderHomepage();
            }
        });

    </script>
</body>
</html>
